---
- name: Install and Configure WordPress Stack
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    php_version: "8.3"
    wp_path: "/var/www/html"

  tasks:

    # --- 1. PRE-CHECKS AND DEPENDENCIES --- #

    - name: Wait for RDS MySQL to become available
      wait_for:
        host: "{{ db_host }}"
        port: "{{ db_port }}"
        timeout: 60
        delay: 5
        state: started
      tags: [db-wait]

    - name: Wait for Redis to become available
      wait_for:
        host: "{{ redis_host }}"
        port: "{{ redis_port }}"
        timeout: 60
        delay: 5
        state: started
      tags: [redis-wait]

    - name: Install system packages
      apt:
        name:
          - nginx
          - "php{{ php_version }}-fpm"
          - "php{{ php_version }}-mysql"
          - "php{{ php_version }}-redis"
          - "php{{ php_version }}-xml"
          - "php{{ php_version }}-mbstring"
          - "php{{ php_version }}-curl"
          - "php{{ php_version }}-zip"
          - "php{{ php_version }}-gd"
          - mysql-client
          - redis-tools
          - composer
          - ca-certificates
          - gettext
          - python3-botocore
          - python3-boto3
          - jq
          - netcat-openbsd
        state: present
        update_cache: yes
      tags: [packages]

    # --- 2. PHP AND REDIS CONFIGURATION --- #

    - name: Download Amazon RDS global SSL certificate bundle
      get_url:
        url: https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
        dest: /etc/ssl/certs/rds-combined-ca-bundle.pem
        mode: '0644'
      tags: [php, config, ssl]

    - name: Update system CA certificates
      command: update-ca-certificates --fresh
      changed_when: false
      tags: [php, config, ssl]

    - name: Configure PHP FPM and CLI to use system CA bundle for SSL
      lineinfile:
        path: "{{ item }}"
        regexp: '^;openssl.cafile='
        line: 'openssl.cafile=/etc/ssl/certs/ca-certificates.crt'
      loop:
        - "/etc/php/{{ php_version }}/fpm/php.ini"
        - "/etc/php/{{ php_version }}/cli/php.ini"
      notify: Restart PHP-FPM
      tags: [php, config, ssl]

    - name: Set secure permissions for PHP session directory
      file:
        path: "/var/lib/php/sessions"
        owner: root
        group: www-data
        mode: '1733'
      tags: [php, config, security]

    - name: Configure PHP to use Redis for session handling over TLS
      copy:
        dest: "/etc/php/{{ php_version }}/fpm/conf.d/99-redis-session.ini"
        content: |
          session.save_handler = redis
          session.save_path = "tls://{{ redis_host }}:{{ redis_port }}?auth={{ redis_auth_token }}&ssl[verify_peer]=0"
          session.cookie_httponly = 1
          session.cookie_secure = 1
        mode: '0644'
      notify: Restart PHP-FPM
      tags: [php, config, redis]

    # --- 3. NGINX CONFIGURATION --- #

    - name: Create Nginx virtual host configuration from template
      template:
        src: templates/wordpress.conf.j2
        dest: /etc/nginx/sites-available/wordpress
        mode: '0644'
      vars:
        wp_path: "{{ wp_path }}"
        php_fpm_socket: "/run/php/php{{ php_version }}-fpm.sock"
      notify: Restart Nginx
      tags: [nginx, config]

    - name: Enable WordPress site and disable default
      file:
        src: /etc/nginx/sites-available/wordpress
        dest: /etc/nginx/sites-enabled/wordpress
        state: link
      notify: Restart Nginx
      tags: [nginx, config]

    - name: Disable default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Restart Nginx
      tags: [nginx, config]

    - name: Optimize Nginx worker processes and connections
      lineinfile:
        path: /etc/nginx/nginx.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^worker_processes', line: 'worker_processes auto;' }
        - { regexp: '^\s*worker_connections\s\w+;', line: '    worker_connections 1024;' }
      notify: Restart Nginx
      tags: [nginx, config, optimization]

    # --- 4. WORDPRESS CORE AND WP-CLI INSTALLATION --- #

    - name: Clone WordPress from Git repository
      git:
        repo: "https://github.com/hetmanskyi-cloud/wordpress.git"
        dest: "/tmp/wordpress-clone"
        version: "{{ wp_version | default('master') }}"
        depth: 1
        force: yes
      tags: [wordpress, install]

    - name: Synchronize WordPress files to the web root
      synchronize:
        src: "/tmp/wordpress-clone/"
        dest: "{{ wp_path }}/"
        rsync_opts:
          - "--delete"
          - "--exclude=wp-content/uploads"
      tags: [wordpress, install]

    - name: Remove temporary WordPress clone directory
      file:
        path: "/tmp/wordpress-clone"
        state: absent
      tags: [wordpress, install]

    - name: Set correct ownership and permissions for WordPress files
      file:
        path: "{{ wp_path }}"
        state: directory
        owner: "www-data"
        group: "www-data"
        recurse: yes
      tags: [wordpress, permissions]

    - name: Ensure wp-content directory is writable by www-data
      file:
        path: "{{ wp_path }}/wp-content"
        state: directory
        owner: "www-data"
        group: "www-data"
        mode: '0755'
      tags: [wordpress, permissions]

    - name: Install Predis library via Composer
      composer:
        command: require
        arguments: predis/predis
        working_dir: "{{ wp_path }}"
      become_user: www-data
      tags: [wordpress, composer]

    - name: Create WP-CLI cache directory for www-data user
      file:
        path: "/tmp/.wp-cli/cache"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
      tags: [wordpress, wp-cli]

    - name: Download WP-CLI (WordPress Command Line Interface)
      get_url:
        url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        dest: /usr/local/bin/wp
        mode: '0755'
      tags: [wordpress, wp-cli]

    # --- 5. WORDPRESS CONFIGURATION AND INSTALLATION --- #

    - name: Verify DB connection with SSL via mysql client
      command: >-
        mysql -h "{{ db_host }}" -u "{{ db_user }}" -p"{{ db_password }}"
        --ssl-ca="/etc/ssl/certs/rds-combined-ca-bundle.pem"
        -e "USE {{ db_name }};"
      changed_when: false
      no_log: true # Prevents secrets from being logged
      tags: [wordpress, db-check]

    - name: Verify DB connection with SSL via PHP mysqli
      shell: |
        php -r "
        \$mysqli = mysqli_init();
        \$mysqli->ssl_set(null, null, '/etc/ssl/certs/rds-combined-ca-bundle.pem', null, null);
        \$mysqli->real_connect('{{ db_host }}', '{{ db_user }}', '{{ db_password }}', '{{ db_name }}', {{ db_port }}, null, MYSQLI_CLIENT_SSL);
        if (\$mysqli->connect_errno) { exit(1); }"
      changed_when: false
      no_log: true
      tags: [wordpress, db-check, ssl]

    - name: Create wp-config.php
      command: >-
        wp config create --path="{{ wp_path }}" --dbname="{{ db_name }}" --dbuser="{{ db_user }}"
        --dbpass="{{ db_password }}" --dbhost="{{ db_host }}" --dbprefix="wp_" --skip-check --force
      become_user: www-data
      args:
        creates: "{{ wp_path }}/wp-config.php"
      no_log: true
      tags: [wordpress, config, wp-cli]

    - name: Configure salts, Redis, URLs, and other settings in wp-config.php
      command: "wp config set {{ item.key }} '{{ item.value }}' --path={{ wp_path }} {{ item.raw | default('') }}"
      loop:
        - { key: 'AUTH_KEY', value: "{{ auth_key }}" }
        - { key: 'SECURE_AUTH_KEY', value: "{{ secure_auth_key }}" }
        - { key: 'LOGGED_IN_KEY', value: "{{ logged_in_key }}" }
        - { key: 'NONCE_KEY', value: "{{ nonce_key }}" }
        - { key: 'AUTH_SALT', value: "{{ auth_salt }}" }
        - { key: 'SECURE_AUTH_SALT', value: "{{ secure_auth_salt }}" }
        - { key: 'LOGGED_IN_SALT', value: "{{ logged_in_salt }}" }
        - { key: 'NONCE_SALT', value: "{{ nonce_salt }}" }
        - { key: 'WP_REDIS_HOST', value: "{{ redis_host }}" }
        - { key: 'WP_REDIS_PORT', value: "{{ redis_port }}" }
        - { key: 'WP_REDIS_PASSWORD', value: "{{ redis_auth_token }}" }
        - { key: 'WP_REDIS_CLIENT', value: 'predis' }
        - { key: 'WP_REDIS_SCHEME', value: 'tls' }
        - { key: 'WP_CACHE', value: 'true', raw: '--raw' }
        - { key: 'WP_SITEURL', value: "{{ site_url }}" }
        - { key: 'WP_HOME', value: "{{ site_url }}" }
        - { key: 'MYSQL_CLIENT_FLAGS', value: 'MYSQLI_CLIENT_SSL', raw: '--raw' }
        - { key: 'MYSQL_SSL_CA', value: '/etc/ssl/certs/rds-combined-ca-bundle.pem' }
        - { key: 'WP_DEBUG', value: 'true', raw: '--raw' }
        - { key: 'WP_DEBUG_LOG', value: '/var/log/wordpress.log' }
        - { key: 'WP_DEBUG_DISPLAY', value: 'false', raw: '--raw' }
      become_user: www-data
      no_log: true # Hides secrets in loop from logs
      tags: [wordpress, config, wp-cli]

    - name: Conditionally force SSL for admin area
      command: "wp config set FORCE_SSL_ADMIN true --raw --path={{ wp_path }}"
      become_user: www-data
      when: enable_https | bool
      tags: [wordpress, config, ssl]

    - name: Add reverse proxy HTTPS snippet to wp-config.php
      blockinfile:
        path: "{{ wp_path }}/wp-config.php"
        marker: "# BEGIN ANSIBLE MANAGED BLOCK: Reverse Proxy Support"
        insertbefore: "/* That's all, stop editing! Happy publishing. */"
        block: |
          if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https') {
              $_SERVER['HTTPS'] = 'on';
          }
      become_user: www-data
      tags: [wordpress, config, ssl]

    - name: Check if WordPress is already installed
      command: "wp core is-installed --path={{ wp_path }}"
      become_user: www-data
      register: wordpress_install_status
      changed_when: false
      failed_when: false
      tags: [wordpress, install, wp-cli]

    - name: Install WordPress core
      command: >-
        wp core install --path="{{ wp_path }}" --url="{{ site_url }}" --title="{{ wp_title }}"
        --admin_user="{{ wp_admin_user }}" --admin_password="{{ wp_admin_password }}"
        --admin_email="{{ wp_admin_email }}" --skip-email
      when: wordpress_install_status.rc != 0
      become_user: www-data
      no_log: true
      tags: [wordpress, install, wp-cli]

    - name: Activate included plugins
      command: "wp plugin activate {{ item }} --path={{ wp_path }}"
      loop: [ 'redis-cache', 'wordfence' ]
      become_user: www-data
      tags: [wordpress, plugins, wp-cli]

    - name: Enable Redis Object Cache
      command: "wp redis enable --path={{ wp_path }}"
      become_user: www-data
      tags: [wordpress, plugins, redis]

    - name: Write secrets to /etc/environment for healthcheck script
      lineinfile:
        path: /etc/environment
        line: "{{ item }}"
        create: yes
      loop:
        - 'DB_NAME="{{ db_name }}"'
        - 'DB_USER="{{ db_user }}"'
        - 'DB_PASSWORD="{{ db_password }}"'
        - 'REDIS_AUTH_TOKEN="{{ redis_auth_token }}"'
      no_log: true
      tags: [wordpress, config]

    # --- 6. POST-INSTALL HEALTHCHECK AND LOGS --- #

    - name: Create WordPress debug log file
      file:
        path: /var/log/wordpress.log
        state: touch
        owner: www-data
        group: www-data
        mode: '0644'
      tags: [wordpress, debug]

    - name: Check if healthcheck file already exists
      stat:
        path: "{{ wp_path }}/healthcheck.php"
      register: healthcheck_file_stat
      tags: [wordpress, healthcheck]

    - name: Download healthcheck.php from S3
      aws_s3:
        bucket: "{{ scripts_bucket_name }}"
        object: "wordpress/healthcheck.php"
        dest: "{{ wp_path }}/healthcheck.php"
        mode: get
      when: not healthcheck_file_stat.stat.exists
      tags: [wordpress, healthcheck]

    - name: Set permissions for healthcheck.php
      file:
        path: "{{ wp_path }}/healthcheck.php"
        owner: www-data
        group: www-data
        mode: '0644'
      tags: [wordpress, healthcheck]

    # --- 7. SYSTEM CLEANUP --- #

    - name: Clean up APT package cache
      apt:
        autoclean: yes
        autoremove: yes
      tags: [cleanup]

  # --- HANDLERS --- #
  handlers:
    - name: Restart PHP-FPM
      listen: Restart PHP-FPM
      service:
        name: "php{{ php_version }}-fpm"
        state: restarted

    - name: Restart Nginx
      listen: Restart Nginx
      service:
        name: nginx
        state: restarted
